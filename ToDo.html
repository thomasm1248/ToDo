<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ToDo</title>
  <style>

#list {
	margin-left: 200px;
}

p {
	margin: 10px;
	margin-left: -15px;
}

div div {
	font-family: Arial;
	font-size: 14px;
	padding-top: 3px;
	padding-bottom: 3px;
	padding-left: 5px;
	width: 400px;
	display: block;
}

#focus {
	border-top: 1px solid black;
	border-bottom: 1px solid black;
	border-right: 200px solid transparent;
	margin-left: 0;
	padding-top: 2px;
	padding-bottom: 2px;
}

.todo {
	border-left: 20px solid lightgray;
}

.done {
	border-left: 20px solid #7cff96;
}

  </style>
</head>
<body>
	<div id="list">
	</div>
  <script>

function l(id) {
	return document.getElementById(id);
}

function make(tag) {
	return document.createElement(tag);
}

function newItem(text, date) {
	return {
		date: date,
		state: "todo",
		text: text
	};
}

var current = {};
var list = [];

var storage = window.localStorage;
var load = storage.getItem("tasks");
if(load !== null) list = JSON.parse(load);

var monthNames = {
	jan: 0,
	feb: 1,
	mar: 2,
	apr: 3,
	may: 4,
	jun: 5,
	jul: 6,
	aug: 7,
	sep: 8,
	oct: 9,
	nov: 10,
	dec: 11
};

var NoDate = function(){};
NoDate.prototype.toDateString = function() {
	return "No Due Date";
};

function renderPage() {
	// An object to store new HTML in
	var newList = make("div");
	
	// Make a list item for every task
	var dateH = "";
	for(var i in list) {
		// Make a header for each date
		var date = list[i].date.toDateString();
		if(date !== dateH) {
			dateH = date;
			var header = make("p");
			header.innerHTML = dateH;
			newList.appendChild(header);
		}
		// Make a new item
		var item = make("div");
		item.className = "item";
		item.innerHTML = list[i].text;
		item.className = list[i].state;
		if(list[i] === current) { // Highlight if focused
			item.id = "focus";
		}
		
		// Add the item
		newList.appendChild(item);
	}
	
	// Replace current HTML with new HTML
	l("list").innerHTML = newList.innerHTML;
}

function getDate() {
	var input = prompt("Due");
	var date = new Date();
	input += "";
	switch(input.length) {
		case 0:
			date = "cancel";
      break;
		case 1:
			if(input === " ") {
				return new NoDate();
			}
			date.setDate(date.getDate() + 1*input);
			break;
		case 2:
			var th = input * 1;
			date.setDate(th);
			if(date < (new Date())) {
				date.setMonth(date.getMonth() + 1);
			}
			break;
		case 3:
			var month = input.slice(0, 1) * 1 - 1;
			var day = input.slice(1) * 1;
			date.setMonth(month);
			date.setDate(day);
			if(date < (new Date())) {
				date.setFullYear(date.getFullYear() + 1);
			}
			break;
		case 4:
			var month = input.slice(0, 2) * 1 - 1;
			var day = input.slice(2) * 1;
			date.setMonth(month);
			date.setDate(day);
			if(date < (new Date())) {
				date.setFullYear(date.getFullYear() + 1);
			}
			break;
		case 5:
			var monthName = monthNames[input.slice(0, 3)];
			var nth = input.slice(3) * 1;
			date.setMonth(monthName);
			date.setDate(nth);
			if(date < (new Date())) {
				date.setFullYear(date.getFullYear() + 1);
			}
			break;
	}
	return date;
}

function sortDates() {
	list.sort(function(a, b) {
		if(a.date.toDateString() === "No Due Date") {
			return 1;
		} else {
			return a.date > b.date;
		}
	});
}

function createTask() {
	var text = prompt("Task");
	if(text !== "") {
		var date = getDate();
		if (date === "cancel") {
			date = new NoDate();
		}
		return newItem(text, date);
	} else {
		return "cancel";
	}
}

document.addEventListener("keydown", function(e) {
	var iOf = list.indexOf(current);
	switch(e.keyCode) {
		case 78:
			var task = createTask();
			if(task !== "cancel") {
				list.push(task);
				current = task;
			}
			break;
		case 69:
			var newText = prompt("");
			if(newText !== "") {
				current.text = newText;
			}
			break;
		case 74:
			if(e.shiftKey) {
				current.date.setDate(
					current.date.getDate() + 1
				);
			} else {
				current = list[iOf + 1 >= list.length ? iOf : iOf + 1];
			}
			break;
		case 75:
			if(e.shiftKey) {
				current.date.setDate(
					current.date.getDate() + -1
				);
			} else {
				current = list[iOf - 1 < 0 ? iOf : iOf - 1];
			}
			break;
		case 68:
			list.splice(iOf, 1);
			if(iOf >= list.length) {
				iOf--;
			}
			current = list[iOf];
			break;
		case 32:
			if(current.state === "todo") {
				current.state = "done";
			} else {
				current.state = "todo";
			}
			break;
		case 83:
			var date = getDate();
			if(date !== "cancel") {
				current.date = date;
			}
			break;
	}
	sortDates();
	storage.setItem("tasks", JSON.stringify(list));
	renderPage();
}, false);

  </script>
</body>
</html>
